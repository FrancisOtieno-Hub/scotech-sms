<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics Dashboard | ScoTech SMS</title>
  <link rel="stylesheet" href="../css/main.css">
</head>
<body>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="../assets/logo.svg" alt="ScoTech SMS" class="logo" onerror="this.style.display='none'">
      <h2>ScoTech SMS</h2>
    </div>
    <nav class="sidebar-nav">
      <a href="../dashboard.html" class="nav-item">
        <span class="nav-icon">üè†</span>
        <span class="nav-text">Dashboard</span>
      </a>
      <div class="nav-section">
        <div class="nav-section-title">Reports</div>
        <a href="dashboard.html" class="nav-item active">
          <span class="nav-icon">üìä</span>
          <span class="nav-text">Analytics</span>
        </a>
        <a href="students.html" class="nav-item">
          <span class="nav-icon">üë•</span>
          <span class="nav-text">Students</span>
        </a>
        <a href="finance.html" class="nav-item">
          <span class="nav-icon">üí∞</span>
          <span class="nav-text">Finance</span>
        </a>
        <a href="custom.html" class="nav-item">
          <span class="nav-icon">üîß</span>
          <span class="nav-text">Custom Reports</span>
        </a>
      </div>
    </nav>
  </aside>
  
  <main class="main-content">
    <header class="topbar">
      <div class="topbar-left">
        <button class="mobile-menu-toggle" id="mobileMenuToggle">‚ò∞</button>
        <h1>Analytics Dashboard</h1>
      </div>
      <div class="topbar-right">
        <button class="btn btn-sm btn-secondary" onclick="window.print()">üñ®Ô∏è Print</button>
        <button class="btn btn-sm btn-danger" id="logoutBtn">Logout</button>
      </div>
    </header>
    
    <div class="content-wrapper">
      <div id="toastContainer" class="toast-container"></div>
      
      <!-- Overview Stats -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 24px;" id="overviewStats"></div>
      
      <!-- Charts Row -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 24px;">
        <!-- Student Enrollment Trend -->
        <div class="card">
          <h3>Student Enrollment by Class</h3>
          <canvas id="enrollmentChart" style="max-height: 300px;"></canvas>
        </div>
        
        <!-- Fee Collection -->
        <div class="card">
          <h3>Fee Collection (Current Term)</h3>
          <canvas id="feeChart" style="max-height: 300px;"></canvas>
        </div>
      </div>
      
      <!-- Data Tables Row -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
        <!-- Top Classes by Enrollment -->
        <div class="card">
          <h3>Classes Overview</h3>
          <table class="data-table">
            <thead>
              <tr>
                <th>Class</th>
                <th>Students</th>
                <th>Capacity</th>
                <th>Utilization</th>
              </tr>
            </thead>
            <tbody id="classesBody"></tbody>
          </table>
        </div>
        
        <!-- Recent Activity -->
        <div class="card">
          <h3>Recent Activity</h3>
          <div id="recentActivity" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
      </div>
      
      <!-- Quick Reports -->
      <div class="card">
        <h3>Quick Reports</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
          <a href="students.html" class="btn btn-primary">üìö Student Reports</a>
          <a href="finance.html" class="btn btn-primary">üí∞ Financial Reports</a>
          <a href="../fees/reports.html" class="btn btn-primary">üíµ Fee Reports</a>
          <a href="../finance/reports.html" class="btn btn-primary">üí∏ Expense Reports</a>
          <a href="custom.html" class="btn btn-secondary">üîß Custom Report Builder</a>
        </div>
      </div>
    </div>
  </main>
  
  <script type="module">
    import { supabase, getCurrentUser, showToast, formatCurrency } from '../js/config.js';
    
    let currentUser = null;
    
    async function init() {
      currentUser = await getCurrentUser();
      if (!currentUser) {
        window.location.href = '/';
        return;
      }
      
      await loadOverviewStats();
      await loadClassesData();
      await loadRecentActivity();
      setupEventListeners();
    }
    
    async function loadOverviewStats() {
      try {
        // Get student count
        const { data: students } = await supabase
          .from('learners')
          .select('id, active, gender')
          .eq('school_id', currentUser.school_id);
        
        const totalStudents = students?.length || 0;
        const activeStudents = students?.filter(s => s.active).length || 0;
        const maleStudents = students?.filter(s => s.active && s.gender === 'Male').length || 0;
        const femaleStudents = students?.filter(s => s.active && s.gender === 'Female').length || 0;
        
        // Get staff count
        const { data: staff } = await supabase
          .from('staff')
          .select('id, active')
          .eq('school_id', currentUser.school_id);
        
        const activeStaff = staff?.filter(s => s.active).length || 0;
        
        // Get current term fee data
        const { data: term } = await supabase
          .from('terms')
          .select('id')
          .eq('school_id', currentUser.school_id)
          .eq('active', true)
          .single();
        
        let feeCollectionRate = 0;
        if (term) {
          const { data: feeSummary } = await supabase
            .from('v_learner_fee_summary')
            .select('total_fees, total_paid')
            .eq('school_id', currentUser.school_id);
          
          const totalExpected = feeSummary?.reduce((sum, s) => sum + Number(s.total_fees), 0) || 0;
          const totalCollected = feeSummary?.reduce((sum, s) => sum + Number(s.total_paid), 0) || 0;
          feeCollectionRate = totalExpected > 0 ? ((totalCollected / totalExpected) * 100).toFixed(1) : 0;
        }
        
        // Display stats
        document.getElementById('overviewStats').innerHTML = `
          <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: var(--radius-sm); color: white;">
            <div style="font-size: 0.9rem; opacity: 0.9;">Total Students</div>
            <div style="font-size: 2.5rem; font-weight: 700; margin: 8px 0;">${totalStudents}</div>
            <div style="font-size: 0.85rem; opacity: 0.8;">${activeStudents} active</div>
          </div>
          <div style="padding: 20px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: var(--radius-sm); color: white;">
            <div style="font-size: 0.9rem; opacity: 0.9;">Gender Distribution</div>
            <div style="font-size: 2.5rem; font-weight: 700; margin: 8px 0;">${maleStudents}/${femaleStudents}</div>
            <div style="font-size: 0.85rem; opacity: 0.8;">Male / Female</div>
          </div>
          <div style="padding: 20px; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); border-radius: var(--radius-sm); color: white;">
            <div style="font-size: 0.9rem; opacity: 0.9;">Active Staff</div>
            <div style="font-size: 2.5rem; font-weight: 700; margin: 8px 0;">${activeStaff}</div>
            <div style="font-size: 0.85rem; opacity: 0.8;">Staff members</div>
          </div>
          <div style="padding: 20px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: var(--radius-sm); color: white;">
            <div style="font-size: 0.9rem; opacity: 0.9;">Fee Collection</div>
            <div style="font-size: 2.5rem; font-weight: 700; margin: 8px 0;">${feeCollectionRate}%</div>
            <div style="font-size: 0.85rem; opacity: 0.8;">Current term</div>
          </div>
        `;
        
      } catch (error) {
        showToast('Error loading stats: ' + error.message, 'error');
      }
    }
    
    async function loadClassesData() {
      try {
        const { data: classes } = await supabase
          .from('classes')
          .select(`
            id,
            name,
            capacity,
            learners(count)
          `)
          .eq('school_id', currentUser.school_id)
          .order('level');
        
        const tbody = document.getElementById('classesBody');
        
        if (!classes || classes.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No data</td></tr>';
          return;
        }
        
        tbody.innerHTML = classes.map(cls => {
          const studentCount = cls.learners?.[0]?.count || 0;
          const capacity = cls.capacity || 0;
          const utilization = capacity > 0 ? Math.round((studentCount / capacity) * 100) : 0;
          
          return `
            <tr>
              <td><strong>${cls.name}</strong></td>
              <td>${studentCount}</td>
              <td>${capacity || '-'}</td>
              <td>
                ${capacity > 0 ? `
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="flex: 1; background: var(--bg-secondary); border-radius: 4px; height: 8px; overflow: hidden;">
                      <div style="background: ${utilization > 100 ? 'var(--danger)' : utilization > 80 ? 'var(--warning)' : 'var(--success)'}; height: 100%; width: ${Math.min(utilization, 100)}%;"></div>
                    </div>
                    <span style="font-weight: 600; min-width: 45px;">${utilization}%</span>
                  </div>
                ` : '-'}
              </td>
            </tr>
          `;
        }).join('');
        
      } catch (error) {
        showToast('Error loading classes: ' + error.message, 'error');
      }
    }
    
    async function loadRecentActivity() {
      try {
        // Get recent students (last 10)
        const { data: recentStudents } = await supabase
          .from('learners')
          .select('first_name, last_name, created_at')
          .eq('school_id', currentUser.school_id)
          .order('created_at', { ascending: false })
          .limit(5);
        
        // Get recent payments (last 5)
        const { data: recentPayments } = await supabase
          .from('payments')
          .select('amount, payment_date, learners(first_name, last_name)')
          .eq('school_id', currentUser.school_id)
          .order('payment_date', { ascending: false })
          .limit(5);
        
        const activityDiv = document.getElementById('recentActivity');
        let activityHtml = '';
        
        if (recentStudents && recentStudents.length > 0) {
          activityHtml += '<h4 style="margin: 0 0 12px 0; font-size: 0.9rem; color: var(--text-secondary);">Recent Registrations</h4>';
          recentStudents.forEach(student => {
            const date = new Date(student.created_at).toLocaleDateString();
            activityHtml += `
              <div style="padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                <div style="font-weight: 600;">${student.first_name} ${student.last_name}</div>
                <div style="font-size: 0.85rem; color: var(--text-secondary);">${date}</div>
              </div>
            `;
          });
        }
        
        if (recentPayments && recentPayments.length > 0) {
          activityHtml += '<h4 style="margin: 16px 0 12px 0; font-size: 0.9rem; color: var(--text-secondary);">Recent Payments</h4>';
          recentPayments.forEach(payment => {
            const date = new Date(payment.payment_date).toLocaleDateString();
            activityHtml += `
              <div style="padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                <div style="font-weight: 600;">${payment.learners?.first_name} ${payment.learners?.last_name}</div>
                <div style="font-size: 0.85rem; color: var(--success);">${formatCurrency(payment.amount)} - ${date}</div>
              </div>
            `;
          });
        }
        
        if (!activityHtml) {
          activityHtml = '<p class="text-muted text-center" style="padding: 40px;">No recent activity</p>';
        }
        
        activityDiv.innerHTML = activityHtml;
        
      } catch (error) {
        console.error('Error loading activity:', error);
      }
    }
    
    function setupEventListeners() {
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (confirm('Logout?')) {
          await supabase.auth.signOut();
          window.location.href = '/';
        }
      });
      
      document.getElementById('mobileMenuToggle')?.addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('mobile-open');
      });
    }
    
    init();
  </script>
</body>
</html>
