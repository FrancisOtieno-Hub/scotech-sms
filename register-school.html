<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register Your School | ScoTech SMS</title>
  <link rel="stylesheet" href="css/main.css">
</head>
<body class="login-page">
  <div class="login-container">
    <div class="login-card" style="max-width: 600px;">
      <div class="login-header">
        <img src="assets/logo.svg" alt="ScoTech SMS" class="logo" onerror="this.style.display='none'">
        <h1>Register Your School</h1>
        <p class="subtitle">Join ScoTech SMS - Modern School Management</p>
      </div>
      
      <div id="toastContainer" class="toast-container"></div>
      
      <form id="registerForm">
        <h3 style="margin-bottom: 16px; color: var(--primary);">School Information</h3>
        
        <div class="form-group">
          <label>School Name *</label>
          <input type="text" id="schoolName" placeholder="e.g., Little Angels Academy" required>
        </div>
        
        <div class="form-group">
          <label>School Motto</label>
          <input type="text" id="motto" placeholder="e.g., Quality Education, Service and Discipline">
        </div>
        
        <div class="form-group">
          <label>Address *</label>
          <textarea id="address" rows="2" placeholder="P.O. Box, Street, City" required></textarea>
        </div>
        
        <div class="form-group">
          <label>Phone Number *</label>
          <input type="tel" id="phone" placeholder="e.g., 0720 985 433" required>
        </div>
        
        <div class="form-group">
          <label>Email Address *</label>
          <input type="email" id="schoolEmail" placeholder="info@yourschool.ac.ke" required>
        </div>
        
        <hr style="margin: 24px 0; border: none; border-top: 2px solid var(--border);">
        
        <h3 style="margin-bottom: 16px; color: var(--primary);">Administrator Account</h3>
        
        <div class="form-group">
          <label>Full Name *</label>
          <input type="text" id="adminName" placeholder="e.g., John Doe" required>
        </div>
        
        <div class="form-group">
          <label>Email Address *</label>
          <input type="email" id="adminEmail" placeholder="admin@yourschool.ac.ke" required>
        </div>
        
        <div class="form-group">
          <label>Password *</label>
          <input type="password" id="password" placeholder="Minimum 8 characters" minlength="8" required>
          <small class="text-muted">Must contain uppercase, lowercase, and number</small>
        </div>
        
        <div class="form-group">
          <label>Confirm Password *</label>
          <input type="password" id="confirmPassword" placeholder="Re-enter password" required>
        </div>
        
        <div class="form-group">
          <label style="display: flex; align-items: start; gap: 12px; cursor: pointer;">
            <input type="checkbox" id="terms" required style="margin-top: 4px;">
            <span style="font-size: 0.9rem;">
              I agree to the <a href="#" target="_blank">Terms of Service</a> and 
              <a href="#" target="_blank">Privacy Policy</a>
            </span>
          </label>
        </div>
        
        <button type="submit" id="registerBtn" class="btn btn-primary btn-block">
          Register School
        </button>
        
        <div style="text-align: center; margin-top: 20px;">
          <p class="text-muted">Already have an account? <a href="index.html">Sign In</a></p>
        </div>
      </form>
      
      <div class="login-footer">
        <p class="text-muted mt-4">Powered by ScoTech © 2026</p>
      </div>
    </div>
  </div>
  
  <script type="module">
    import { supabase, showToast, setButtonLoading } from './js/config.js';
    
    const registerForm = document.getElementById('registerForm');
    const registerBtn = document.getElementById('registerBtn');
    
    // Password validation
    function validatePassword(password) {
      if (password.length < 8) {
        return 'Password must be at least 8 characters';
      }
      if (!/[A-Z]/.test(password)) {
        return 'Password must contain uppercase letter';
      }
      if (!/[a-z]/.test(password)) {
        return 'Password must contain lowercase letter';
      }
      if (!/[0-9]/.test(password)) {
        return 'Password must contain number';
      }
      return null;
    }
    
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Get form values
      const schoolName = document.getElementById('schoolName').value.trim();
      const motto = document.getElementById('motto').value.trim();
      const address = document.getElementById('address').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const schoolEmail = document.getElementById('schoolEmail').value.trim();
      const adminName = document.getElementById('adminName').value.trim();
      const adminEmail = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      // Validate passwords match
      if (password !== confirmPassword) {
        showToast('Passwords do not match', 'error');
        return;
      }
      
      // Validate password strength
      const passwordError = validatePassword(password);
      if (passwordError) {
        showToast(passwordError, 'error');
        return;
      }
      
      setButtonLoading(registerBtn, true, 'Creating your school...');
      
      try {
        // Step 1: Create school
        const { data: school, error: schoolError } = await supabase
          .from('schools')
          .insert({
            name: schoolName,
            motto: motto,
            address: address,
            phone: phone,
            email: schoolEmail,
            active: true,
            subscription_plan: 'basic'
          })
          .select()
          .single();
        
        if (schoolError) throw schoolError;
        
        // Step 2: Create admin auth user
        const { data: authData, error: authError } = await supabase.auth.signUp({
          email: adminEmail,
          password: password,
          options: {
            data: {
              full_name: adminName,
              school_id: school.id
            }
          }
        });
        
        if (authError) {
          // Rollback school creation
          await supabase.from('schools').delete().eq('id', school.id);
          throw authError;
        }
        
        // Step 3: Create user profile
        const { error: profileError } = await supabase
          .from('user_profiles')
          .insert({
            id: authData.user.id,
            school_id: school.id,
            email: adminEmail,
            full_name: adminName,
            role: 'school_admin',
            active: true
          });
        
        if (profileError) {
          // Rollback
          await supabase.from('schools').delete().eq('id', school.id);
          throw profileError;
        }
        
        // Step 4: Seed default data (classes, expense categories)
        try {
          await supabase.rpc('seed_classes', { p_school_id: school.id });
          await supabase.rpc('seed_expense_categories', { p_school_id: school.id });
        } catch (seedError) {
          console.warn('Seed error (non-fatal):', seedError);
        }
        
        showToast('✓ School registered successfully! Please check your email to verify your account.', 'success');
        
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 3000);
        
      } catch (error) {
        showToast('Registration failed: ' + error.message, 'error');
        setButtonLoading(registerBtn, false, 'Register School');
      }
    });
    
    // Real-time password validation feedback
    document.getElementById('password').addEventListener('input', (e) => {
      const error = validatePassword(e.target.value);
      const input = e.target;
      
      if (error && e.target.value.length > 0) {
        input.style.borderColor = 'var(--danger)';
      } else if (e.target.value.length >= 8) {
        input.style.borderColor = 'var(--success)';
      } else {
        input.style.borderColor = '';
      }
    });
  </script>
</body>
</html>
